# A Contrario Detection of H.264 Video Double Compression


This is a project detecting whether a video has been recompressed,
and to estimate the fixed size of the primary Group of Pictures (GOP) of 
a recompressd video. 

The project consists of two parts:
* An inspector for H.264 videos that extracts the
intermediate data during the decompression. At present it can
extract the prediction residuals, macroblock types, frame types,
display order and picture coding order. The extractor is based on the
[JM software](https://iphome.hhi.de/suehring/tml/) 
and its [extension](https://vqeg.github.io/software-tools/encoding/modified-avc-codec/).
* An _a Contrario_ detector that detects potential periodic sequence
of residual peaks in P-frames and validate the sequence if the Number
of False Alarms (NFA) is significantly small.


## Before using

1. Install [ffmpeg](https://ffmpeg.org/). You could
use 3rd-party tool to install ffmpeg:

    Ubuntu / Debian:
    ```bash
    sudo add-apt-repository ppa:savoury1/ffmpeg4 -y
    sudo add-apt-repository ppa:savoury1/ffmpeg5 -y
    sudo apt update
    sudo apt install ffmpeg
    ```
   MacOS:
    ```bash
   brew install ffmpeg
    ```
   
    Or install from the official [website](https://ffmpeg.org/download.html).
    
    No matter which installation method is used, make sure ffmpeg can
    be run from bash, e.g.:
    ```bash
    $ ffmpeg -version
   
   ffmpeg version 5.1.2 Copyright (c) 2000-2022 the FFmpeg developers
    built with Apple clang version 14.0.0 (clang-1400.0.29.202)
    configuration: --prefix=/opt/homebrew/Cellar/ffmpeg/5.1.2_1 --enable-shared --enable-pthreads --enable-version3 --cc=clang --host-cflags= --host-ldflags= --enable-ffplay --enable-gnutls --enable-gpl --enable-libaom --enable-libbluray --enable-libdav1d --enable-libmp3lame --enable-libopus --enable-librav1e --enable-librist --enable-librubberband --enable-libsnappy --enable-libsrt --enable-libtesseract --enable-libtheora --enable-libvidstab --enable-libvmaf --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxml2 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype --enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libopenjpeg --enable-libspeex --enable-libsoxr --enable-libzmq --enable-libzimg --disable-libjack --disable-indev=jack --enable-videotoolbox --enable-neon
    libavutil      57. 28.100 / 57. 28.100
    libavcodec     59. 37.100 / 59. 37.100
    libavformat    59. 27.100 / 59. 27.100
    libavdevice    59.  7.100 / 59.  7.100
    libavfilter     8. 44.100 /  8. 44.100
    libswscale      6.  7.100 /  6.  7.100
    libswresample   4.  7.100 /  4.  7.100
    libpostproc    56.  6.100 / 56.  6.100
    ```

2. Clone the project (branch `apate`):
   ```bash
   git clone -b apate --recurse-submodules https://github.com/li-yanhao/gop_detection.git
   ```

3. Compile the H.264 decoder (JM software)
   ```bash
   cd jm
   make -j
   ```

4. Install the python requirements for the _a Contrario_ detector.
The code was tested in python 3.10.19
   ```bash
   conda create --name apate python=3.10.19
   conda activate apate
   
   pip install -r requirements.txt
   ```

Done! Now all the prerequisites are installed.

## Usage
The input video file must be encoded in H.264. It can be a video file in `.mp4`, `.avi`, `.mkv`, `.mov`, `.qt`, `.264`
or `.h264`.
```bash
python perform_video_analysis.py <input_video_filename> 
```

You can choose a Region of Interest (ROI) at the beginning of the program. If no ROI is selected, the full
frame will be analyzed.

For example:
```bash
$ python perform_video_analysis.py asset/office_recompressed.mp4
Starting application...
No ROI selected, analyzing full frame.

Decoding frames ...

Decoding residuals ...

Decoding finished successfully.

Frames are saved in:  tmp/office_recompressed/frames

Prediction residuals are saved in:  tmp/office_recompressed/residuals

Detected candidates are:
periodicity=31 offset=0 NFA=0.00018751240128970711

Estimated primary GOP = 31
NFA = 0.00018751240128970711
```

The histogram of the residuals in P-frames shows periodic peaks highlighted in <span style="color:cyan"> cyan</span>:
![alt text](asset/office_recompressed_full.png)



### Use for forgery detection

You can also select a region of interest (ROI) to perform the detection on a specific area of the video. For instance, in a faceswap video, the background area originated from a primary authentic video may have been compressed twice, while the face area modified or generated by software may have been compressed only once during the final compression. 

An example is `asset/fake_003.mp4`. 
Running the detection on the face area does NOT find any evidence of double compression:
![alt text](asset/003_fake_face_viz.png)
```
Estimated primary GOP = -1
NFA = inf
```
The histogram of the residuals in P-frames does NOT show any periodic pattern:
![alt text](asset/003_fake_face.png)



Running the detection on the background area results in positive detection of double compression:
![alt text](asset/003_fake_background_viz.png)
```
Estimated primary GOP = 30
NFA = 7.679586275143973e-13
```
The histogram of the residuals in P-frames shows clear periodic peaks (highlighted in <span style="color:cyan"> cyan</span>):
![alt text](asset/003_fake_background.png)



# Large temporary files

At each run the program decodes the full frames and prediction residuals in a temporary folder under `gop_detection/tmp/`, then 
detects double compression using these data. The intermediate
data can take several GB depending on the resolution and
the length of the video. You can safely delete the `tmp/` folder after running the program.

# Citation
If you find this code useful in your research, please cite the following paper:

```@inproceedings{li2023contrario,
  title={A contrario detection of h. 264 video double compression},
  author={Li, Yanhao and Gardella, Marina and Bammey, Quentin and Nikoukhah, Tina and Morel, Jean-Michel and Colom, Miguel and Von Gioi, Rafael Grompone},
  booktitle={2023 IEEE International Conference on Image Processing (ICIP)},
  pages={1765--1769},
  year={2023},
  organization={IEEE}
}
```
